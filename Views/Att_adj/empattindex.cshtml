@model IEnumerable<HRworks.Models.hik>

@{
    ViewBag.Title = "Attendance Calendar";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Group entries by date
    var grouped = Model
        .Where(x => x.date.HasValue)
        .GroupBy(x => x.date.Value.Date)
        .ToDictionary(g => g.Key, g => g.ToList());

    // Decide which month to show
    DateTime referenceDate;

    if (ViewBag.CalendarYear != null && ViewBag.CalendarMonth != null)
    {
        referenceDate = new DateTime(
            (int)ViewBag.CalendarYear,
            (int)ViewBag.CalendarMonth,
            1
        );
    }
    else if (grouped.Any())
    {
        referenceDate = grouped.Keys.Min();
        referenceDate = new DateTime(referenceDate.Year, referenceDate.Month, 1);
    }
    else
    {
        referenceDate = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);
    }

    var year = referenceDate.Year;
    var month = referenceDate.Month;
    var firstOfMonth = new DateTime(year, month, 1);
    var daysInMonth = DateTime.DaysInMonth(year, month);
    var startDayOfWeek = (int)firstOfMonth.DayOfWeek; // 0 = Sunday
}

<!-- jQuery UI CSS (for datepicker + dialog) -->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />

<div class="att-page">
    <div class="att-hero">
        <div class="att-hero-title">
            <span class="att-hero-kicker">Attendance</span>
            <h2 class="att-hero-month">@firstOfMonth.ToString("MMMM yyyy")</h2>
        </div>
    </div>

    <div class="att-filters-card">
        @using (Html.BeginForm("empattindex", "Att_adj", FormMethod.Get, new { @class = "att-filters-form" }))
        {
            <div class="att-filters-row">
                <div class="att-filter">
                    <input type="text"
                           name="empatdatefrom"
                           id="empatdatefrom"
                           class="form-control att-input"
                           placeholder="Select Month" />
                </div>

                <div class="att-actions">
                    <input type="submit" value="Search" class="btn att-btn att-btn-primary" />

                    <button type="button"
                            class="btn att-btn att-btn-ghost"
                            onclick="window.location.href='@Url.Action("empattindex", "Att_adj", new { empatdatefrom = DateTime.Today })'">
                        This Month
                    </button>

                    <button type="button"
                            class="btn att-btn att-btn-ghost"
                            onclick="window.location.href='@Url.Action("Index", "Att_adj")'">
                        Attendance adjustment
                    </button>
                </div>
            </div>
        }
    </div>

    <div class="att-calendar-card">
        <table class="att-calendar">
            <!-- calendar "header" row (no thead to avoid layout conflicts) -->
            <tr class="att-header-row">
                <th>Sun</th>
                <th>Mon</th>
                <th>Tue</th>
                <th>Wed</th>
                <th>Thu</th>
                <th>Fri</th>
                <th>Sat</th>
            </tr>

            @{
                var dayCounter = 1;
                var maxWeeks = 6;
            }

            @for (var week = 0; week < maxWeeks; week++)
            {
                <tr>
                    @for (var dow = 0; dow < 7; dow++)
                    {
                        if ((week == 0 && dow < startDayOfWeek) || dayCounter > daysInMonth)
                        {
                            <td class="att-cell att-cell-empty"></td>
                        }
                        else
                        {
                            var currentDate = new DateTime(year, month, dayCounter);
                            var hasEntries = grouped.ContainsKey(currentDate);

                            var entries = hasEntries
                                ? grouped[currentDate]
                                    .OrderBy(x => x.datetime.HasValue ? x.datetime.Value : DateTime.MinValue)
                                    .ToList()
                                : new List<HRworks.Models.hik>();

                            <td class="att-cell @(hasEntries ? "att-cell-has" : "")">
                                <div class="att-day-head">
                                    <span class="att-day-number">@dayCounter</span>
                                </div>

                                @if (hasEntries && entries.Count > 0)
                                {
                                    var first = entries.First();
                                    var last = entries.Count > 1 ? entries.Last() : null;

                                    <div class="att-punch-list">

                                        <!-- First entry -->
                                        <div class="att-punch-row">
                                            <span class="att-time">@first.time</span>
                                            <button type="button"
                                                    class="att-adjust-btn"
                                                    data-date="@first.date.Value.ToString("yyyy-MM-dd")"
                                                    data-time="@first.time"
                                                    data-displaydate="@first.date.Value.ToString("dd MMM yyyy")"
                                                    data-displaytime="@first.time">
                                                Adjust
                                            </button>
                                        </div>

                                        <!-- Last entry (only if different) -->
                                        @if (last != null && last.time != first.time)
                                        {
                                            <div class="att-punch-row">
                                                <span class="att-time">@last.time</span>
                                                <button type="button"
                                                        class="att-adjust-btn"
                                                        data-date="@last.date.Value.ToString("yyyy-MM-dd")"
                                                        data-time="@last.time"
                                                        data-displaydate="@last.date.Value.ToString("dd MMM yyyy")"
                                                        data-displaytime="@last.time">
                                                    Adjust
                                                </button>
                                            </div>
                                        }
                                    </div>
                                }
                            </td>

                            dayCounter++;
                        }
                    }
                </tr>

                if (dayCounter > daysInMonth)
                {
                    break;
                }
            }
        </table>
    </div>
</div>

<!-- Dialog container -->
<div id="attAdjustDialog" title="Attendance adjustment" style="display:none;">
    <div class="att-dialog-body">
        <div class="att-dialog-line">
            <span class="att-dialog-label">Date</span>
            <span class="att-dialog-value" id="dlgDate"></span>
        </div>
        <div class="att-dialog-line">
            <span class="att-dialog-label">Time</span>
            <span class="att-dialog-value" id="dlgTime"></span>
        </div>
        <div class="att-dialog-hint">Choose adjustment type for this punch:</div>
    </div>
</div>

<style>
    /* ===== Page Theme ===== */
    .att-page {
        padding: 6px 0 24px 0;
        font-family: "Segoe UI", Tahoma, Arial, sans-serif;
        color: #0f172a;
    }

    .att-hero {
        background: linear-gradient(135deg, #0f2436 0%, #143a5a 55%, #1b4e78 100%);
        color: #fff;
        border-radius: 10px;
        padding: 18px 20px 16px 20px;
        margin-bottom: 14px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }

    .att-hero-kicker {
        opacity: 0.85;
        font-size: 12px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
    }

    .att-hero-month {
        margin: 2px 0 0 0;
        font-weight: 600;
        font-size: 28px;
    }

    /* ===== Filters Card ===== */
    .att-filters-card {
        background: #ffffff;
        border: 1px solid #e6edf5;
        border-radius: 10px;
        padding: 14px 16px;
        margin-bottom: 14px;
        box-shadow: 0 2px 10px rgba(15, 23, 42, 0.04);
    }

    .att-filters-row {
        display: flex;
        align-items: flex-end;
        gap: 18px;
        flex-wrap: wrap;
    }

    .att-filter {
        min-width: 220px;
    }

    .att-label {
        display: block;
        margin-bottom: 6px;
        font-size: 11px;
        font-weight: 600;
        color: #334155;
    }

    .att-input {
        border-radius: 8px;
        height: 36px;
        border-color: #dbe5ef;
        box-shadow: none;
    }

    .att-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .att-btn {
        border-radius: 8px;
        padding: 7px 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .att-btn-primary {
        background: #0f2436;
        border: 1px solid #0f2436;
        color: #fff;
    }

        .att-btn-primary:hover {
            background: #0b1c2a;
            border-color: #0b1c2a;
            color: #fff;
        }

    .att-btn-ghost {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        color: #0f172a;
    }

        .att-btn-ghost:hover {
            background: #f1f5f9;
        }

    /* ===== Calendar Card ===== */
    .att-calendar-card {
        background: #ffffff;
        border: 1px solid #e6edf5;
        border-radius: 10px;
        padding: 10px;
        box-shadow: 0 2px 10px rgba(15, 23, 42, 0.04);
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .att-calendar {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
        margin: 0;
        min-width: 720px;
    }

        .att-calendar .att-header-row th {
            background: #0f2436;
            color: #fff;
            padding: 10px 0;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid #0a1a26;
            text-align: center;
        }
    .body-content .att-calendar th {
        position: sticky !important;
        top: auto !important;
    }

    .att-cell {
        border: 1px solid #eef2f7;
        vertical-align: top;
        height: 130px;
        padding: 10px 10px 8px 10px;
        background: #fff;
    }

    .att-cell-empty {
        background: #f8fafc;
    }

    .att-cell-has {
        background: #f4f9ff;
    }

    .att-day-head {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 6px;
    }

    .att-day-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: #e9eef5;
        color: #0f2436;
        font-size: 11px;
        font-weight: 700;
    }

    .att-punch-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding-right: 2px;
    }

    .att-punch-row {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 10px;
    }

    .att-time {
        min-width: 70px;
        font-size: 12px;
        font-weight: 600;
        color: #0f172a;
    }

    .att-adjust-btn {
        background: transparent;
        border: 1px solid #d5dde7;
        color: #0f2436;
        font-size: 11px;
        font-weight: 600;
        padding: 3px 10px;
        border-radius: 6px;
        cursor: pointer;
        white-space: nowrap;
    }

        .att-adjust-btn:hover {
            background: #eef5ff;
            border-color: #c9d7ea;
        }

    /* ===== Dialog Theme ===== */
    .ui-dialog {
        border-radius: 10px !important;
        overflow: hidden;
        border: 1px solid #e6edf5 !important;
        box-shadow: 0 10px 30px rgba(0,0,0,0.12) !important;
    }

    .ui-dialog-titlebar {
        background: #0f2436 !important;
        color: #fff !important;
        border: none !important;
        padding: 10px 12px !important;
    }

    .ui-dialog-title {
        font-size: 13px !important;
        font-weight: 600 !important;
    }

    .ui-dialog-content {
        padding: 14px 16px !important;
    }

    .ui-dialog-buttonpane {
        padding: 8px 10px !important;
        border-top: 1px solid #eef2f7 !important;
        background: #fafcff !important;
    }

    .ui-dialog-buttonset button {
        border-radius: 8px !important;
        font-size: 12px !important;
        font-weight: 600 !important;
        padding: 6px 12px !important;
        margin-left: 6px !important;
    }

    .att-dialog-body {
        font-size: 12.5px;
    }

    .att-dialog-line {
        display: flex;
        gap: 10px;
        margin-bottom: 6px;
    }

    .att-dialog-label {
        width: 40px;
        font-weight: 700;
        color: #334155;
    }

    .att-dialog-value {
        font-weight: 600;
        color: #0f172a;
    }

    .att-dialog-hint {
        margin-top: 10px;
        font-size: 12px;
        color: #64748b;
    }

    /* ===== Responsive ===== */

    @@media (max-width: 992px) {
        .att-cell {
            height: auto;
            min-height: 120px;
        }

        .att-time {
            min-width: 60px;
            font-size: 11px;
        }

        .att-punch-row {
            gap: 6px;
            flex-wrap: wrap;
        }

        .att-adjust-btn {
            padding: 2px 8px;
            font-size: 10px;
        }
    }

    @@media (max-width: 768px) {
        .att-hero {
            background: none;
            color: #0f172a;
            box-shadow: none;
            border-radius: 0;
            padding: 0 0 8px 0;
        }

        .att-hero-kicker {
            display: none;
        }

        .att-hero-month {
            font-size: 22px;
            margin: 0;
        }

        .att-filters-card {
            padding: 10px 12px;
            border-radius: 0;
        }

        .att-filters-row {
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
        }

        .att-calendar-card {
            padding: 8px;
        }
    }

    @@media (max-width: 480px) {
        .att-punch-row {
            flex-direction: column;
            align-items: flex-start;
        }

        .att-time {
            min-width: 0;
        }

        .att-calendar-card {
            padding: 8px 0;
        }
    }
</style>

@section Scripts {
    @* Requires jQuery already in _Layout *@
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <script>
        $(function () {

            // Datepicker for search
            $("#empatdatefrom").datepicker({
                changeMonth: true,
                changeYear: true,
                dateFormat: "mm/dd/yy"
            });

            var baseCreateUrl = '@Url.Action("create", "Att_adj")';

            function openAdjustDialog(dateVal, timeVal, displayDate, displayTime) {
                $("#dlgDate").text(displayDate || dateVal);
                $("#dlgTime").text(displayTime || timeVal);

                var lateUrl = baseCreateUrl
                    + "?atjdate=" + encodeURIComponent(dateVal)
                    + "&atjtime=" + encodeURIComponent(timeVal)
                    + "&inout=true";

                var earlyUrl = baseCreateUrl
                    + "?atjdate=" + encodeURIComponent(dateVal)
                    + "&atjtime=" + encodeURIComponent(timeVal)
                    + "&inout=false";

                $("#attAdjustDialog").dialog({
                    modal: true,
                    width: 380,
                    resizable: false,
                    buttons: [
                        {
                            text: "Late In",
                            click: function () { window.location.href = lateUrl; }
                        },
                        {
                            text: "Early Out",
                            click: function () { window.location.href = earlyUrl; }
                        },
                        {
                            text: "Cancel",
                            click: function () { $(this).dialog("close"); }
                        }
                    ]
                });
            }

            // Click handler for each Adjust button
            $(document).on("click", ".att-adjust-btn", function () {
                var $btn = $(this);

                var dateVal = $btn.data("date");
                var timeVal = $btn.data("time");
                var displayDate = $btn.data("displaydate");
                var displayTime = $btn.data("displaytime");

                openAdjustDialog(dateVal, timeVal, displayDate, displayTime);
            });
        });
    </script>
}
